(function(){var e,t,n,r=function(e,t){return function(){return e.apply(t,arguments)}},i=[].slice;e=this.jQuery||this.Zepto;if(!e){throw"jQuery/Zepto required"}this.PaymentTag=function(){function t(t){var n,i;if(t==null){t={}}this.changeCardType=r(this.changeCardType,this);this.restrictNumeric=r(this.restrictNumeric,this);this.formatNumber=r(this.formatNumber,this);this.handleToken=r(this.handleToken,this);this.submit=r(this.submit,this);this.$el=t.el||"<payment />";this.$el=e(this.$el);t.key||(t.key=this.$el.attr("key")||this.$el.attr("data-key"));if((n=t.cvc)==null){t.cvc=!(this.$el.attr("nocvc")!=null||this.$el.attr("data-nocvc")!=null)}if((i=t.token)==null){t.token=!(this.$el.attr("notoken")!=null||this.$el.attr("data-notoken")!=null)}t.form||(t.form=this.$el.parents("form"));this.options=e.extend({},this.defaults,t);if(this.options.key){this.setKey(this.options.key)}this.setForm(this.options.form);this.$el.delegate(".number input","keydown",this.formatNumber);this.$el.delegate(".number input","keyup",this.changeCardType);this.$el.delegate("input[type=tel]","keypress",this.restrictNumeric)}t.replaceTags=function(t){var n=this;if(t==null){t=document.body}return e("payment, .payment-tag",t).each(function(e,t){return(new n({el:t})).render()})};t.prototype.defaults={tokenName:"stripe_token",token:true,cvc:true};t.prototype.render=function(){this.$el.html(this.constructor.view(this));this.$name=this.$(".name input");this.$address_line1=this.$(".address_line1 input");this.$address_line2=this.$(".address_line2 input");this.$address_city=this.$(".address .city input");this.$address_state=this.$(".address .state input");this.$address_zip=this.$(".address .zip input");this.$address_country=this.$(".address_country input");this.$number=this.$(".number input");this.$cvc=this.$(".cvc input");this.$expiryMonth=this.$(".expiry input.expiryMonth");this.$expiryYear=this.$(".expiry input.expiryYear");this.$message=this.$(".message");return this};t.prototype.renderToken=function(t){this.$token=e('<input type="hidden">');this.$token.attr("name",this.options.tokenName);this.$token.val(t);return this.$el.html(this.$token)};t.prototype.setForm=function(t){this.$form=e(t);return this.$form.bind("submit.payment",this.submit)};t.prototype.setKey=function(e){this.key=e;return Stripe.setPublishableKey(this.key)};t.prototype.validate=function(){var e,t;t=true;this.$("div").removeClass("invalid");this.$message.empty();if(!Stripe.validateCardNumber(this.$number.val())){t=false;this.handleError({code:"invalid_number"})}e=this.expiryVal();if(!Stripe.validateExpiry(e.month,e.year)){t=false;this.handleError({code:"expired_card"})}if(this.options.cvc&&!Stripe.validateCVC(this.$cvc.val())){t=false;this.handleError({code:"invalid_cvc"})}if(!t){this.$(".invalid input:first").select()}return t};t.prototype.createToken=function(e){var t,n,r=this;t=function(t,n){if(n.error){return e(n.error)}else{return e(null,n)}};n=this.expiryVal();return Stripe.createToken({name:this.$name.val(),address_line1:this.$address_line1.val(),address_line2:this.$address_line2.val(),address_city:this.$address_city.val(),address_state:this.$address_state.val(),address_zip:this.$address_zip.val(),address_country:this.$address_country.val(),number:this.$number.val(),cvc:this.$cvc.val()||null,exp_month:n.month,exp_year:n.year},t)};t.prototype.submit=function(e){if(e!=null){e.preventDefault()}if(e!=null){e.stopImmediatePropagation()}if(!this.validate()){return}if(this.pending){return}this.pending=true;this.disableInputs();this.trigger("pending");this.$el.addClass("pending");return this.createToken(this.handleToken)};t.prototype.handleToken=function(e,t){this.enableInputs();this.trigger("complete");this.$el.removeClass("pending");this.pending=false;if(e){return this.handleError(e)}else{this.trigger("success",t);this.$el.addClass("success");if(this.options.token){this.renderToken(t.id)}this.$form.unbind("submit.payment",this.submit);return this.$form.submit()}};t.prototype.formatNumber=function(e){var t,n,r;t=String.fromCharCode(e.which);if(!/^\d+$/.test(t)){return}r=this.$number.val();if(Stripe.cardType(r)==="American Express"){n=r.match(/^(\d{4}|\d{4}\s\d{6})$/)}else{n=r.match(/(?:^|\s)(\d{4})$/)}if(n){return this.$number.val(r+" ")}};t.prototype.restrictNumeric=function(e){var t;if(e.shiftKey||e.metaKey){return true}if(e.which===0){return true}t=String.fromCharCode(e.which);return!/[A-Za-z]/.test(t)};t.prototype.cardTypes={Visa:"visa","American Express":"amex",MasterCard:"mastercard",Discover:"discover",Unknown:"unknown"};t.prototype.changeCardType=function(e){var t,n,r,i;r=Stripe.cardType(this.$number.val());if(!this.$number.hasClass(r)){i=this.cardTypes;for(n in i){t=i[n];this.$number.removeClass(t)}return this.$number.addClass(this.cardTypes[r])}};t.prototype.handleError=function(e){if(e.message){this.$message.text(e.message)}switch(e.code){case"card_declined":this.invalidInput(this.$number);break;case"invalid_number":case"incorrect_number":this.invalidInput(this.$number);break;case"invalid_expiry_month":this.invalidInput(this.$expiryMonth);break;case"invalid_expiry_year":case"expired_card":this.invalidInput(this.$expiryYear);break;case"invalid_cvc":this.invalidInput(this.$cvc)}this.$("label.invalid:first input").select();this.trigger("error",e);return typeof console!=="undefined"&&console!==null?console.error("Stripe error:",e):void 0};t.prototype.invalidInput=function(e){e.parent().addClass("invalid");return this.trigger("invalid",[e.attr("name"),e])};t.prototype.expiryVal=function(){var e,t,n,r;n=function(e){return e.replace(/^\s+|\s+$/g,"")};e=n(this.$expiryMonth.val());r=n(this.$expiryYear.val());if(r.length===2){t=(new Date).getFullYear();t=t.toString().slice(0,2);r=t+r}return{month:e,year:r}};t.prototype.enableInputs=function(){var t;t=this.$el.add(this.$form).find(":input");return t.each(function(){var n,r;n=e(this);return t.attr("disabled",(r=n.data("olddisabled"))!=null?r:false)})};t.prototype.disableInputs=function(){var t;t=this.$el.add(this.$form).find(":input");return t.each(function(){var t;t=e(this);t.data("olddisabled",t.attr("disabled"));return t.attr("disabled",true)})};t.prototype.trigger=function(){var e,t,n;t=arguments[0],e=2<=arguments.length?i.call(arguments,1):[];return(n=this.$el).trigger.apply(n,[""+t+".payment"].concat(i.call(e)))};t.prototype.$=function(t){return e(t,this.$el)};return t}();document.createElement("payment");if(typeof module!=="undefined"&&module!==null){module.exports=PaymentTag}t=this;if(t.Stripe){e(function(){return typeof PaymentTag.replaceTags==="function"?PaymentTag.replaceTags():void 0})}else{n=document.createElement("script");n.onload=n.onreadystatechange=function(){if(!t.Stripe){return}if(n.done){return}n.done=true;return typeof PaymentTag.replaceTags==="function"?PaymentTag.replaceTags():void 0};n.src="https://js.stripe.com/v1/";e(function(){var e;e=document.getElementsByTagName("script")[0];return e!=null?e.parentNode.insertBefore(n,e):void 0})}}).call(this);(function(){this.PaymentTag||(this.PaymentTag={});this.PaymentTag["view"]=function(e){if(!e)e={};var t=[],n=function(e){var n=t,r;t=[];e.call(this);r=t.join("");t=n;return i(r)},r=function(e){if(e&&e.ecoSafe){return e}else if(typeof e!=="undefined"&&e!=null){return o(e)}else{return""}},i,s=e.safe,o=e.escape;i=e.safe=function(e){if(e&&e.ecoSafe){return e}else{if(!(typeof e!=="undefined"&&e!=null))e="";var t=new String(e);t.ecoSafe=true;return t}};if(!o){o=e.escape=function(e){return(""+e).replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}(function(){(function(){compiled=_.template($("#tmpl-card").html(),{options:this.options});t.push(compiled)}).call(this)}).call(e);e.safe=s,e.escape=o;return t.join("")}}).call(this);